extends layout

block content
  if perfume
    .container.mx-auto.px-4.py-8
      // Breadcrumb
      .text-sm.breadcrumbs.mb-6
        ul
          li
            a(href='/')
              i.fas.fa-home.mr-1
              | Trang ch·ªß
          li
            a(href='/')
              i.fas.fa-spray-can.mr-1
              | S·∫£n ph·∫©m
          li= perfume.perfumeName

      // Product Details
      .grid.gap-8.mb-12(class='lg:grid-cols-2')
        // Image
        .card.bg-base-100.shadow-xl
          figure.h-96
            img.w-full.h-full.object-cover(src=perfume.uri, alt=perfume.perfumeName)
          .card-body
            .flex.flex-wrap.gap-2
              if perfume.concentration && perfume.concentration.toLowerCase() === 'extrait'
                .badge.badge-secondary.badge-lg.gap-2
                  i.fas.fa-star
                  | Extrait - Cao c·∫•p
              else if perfume.concentration
                .badge.badge-outline.badge-lg= perfume.concentration
              .badge.badge-ghost.gap-2
                i.fas.fa-venus-mars
                | #{perfume.targetAudience}
              .badge.badge-ghost.gap-2
                i.fas.fa-flask
                | #{perfume.volume}ml

        // Info
        div
          h1.text-4xl.font-bold.mb-4= perfume.perfumeName
          .flex.items-center.gap-3.mb-6
            .text-4xl.font-bold.text-primary $#{perfume.price}
            .badge.badge-lg.badge-success C√≤n h√†ng
          
          .card.bg-base-200.shadow-lg.mb-6
            .card-body
              h3.card-title
                i.fas.fa-tag.mr-2
                | Th∆∞∆°ng hi·ªáu
              p.text-lg= perfume.brand && perfume.brand.brandName

          .card.bg-base-200.shadow-lg.mb-6
            .card-body
              h3.card-title
                i.fas.fa-info-circle.mr-2
                | M√¥ t·∫£
              p= perfume.description

          .card.bg-base-200.shadow-lg
            .card-body
              h3.card-title
                i.fas.fa-leaf.mr-2
                | Th√†nh ph·∫ßn
              p= perfume.ingredients

      .divider.my-12

      // Comments Section
      .max-w-4xl.mx-auto
        .card.bg-base-100.shadow-xl.mb-8
          .card-body
            h2.text-3xl.font-bold.mb-6
              i.fas.fa-comments.mr-3
              | ƒê√°nh Gi√° S·∫£n Ph·∫©m
              if perfume.comments && perfume.comments.length
                .badge.badge-lg.badge-primary.ml-3= perfume.comments.length + ' ƒë√°nh gi√°'
            
            if perfume.comments && perfume.comments.length
              .space-y-4
                each c in perfume.comments
                  .card.bg-base-200.shadow
                    .card-body.py-4
                      .flex.justify-between.items-start.mb-3
                        div
                          .flex.items-center.gap-3
                            .avatar.placeholder
                              .bg-neutral.text-neutral-content.rounded-full.w-12
                                span= (c.author && c.author.name) ? c.author.name.charAt(0).toUpperCase() : '?'
                            div
                              .font-bold.text-lg= (c.author && c.author.name) || '·∫®n danh'
                              .text-sm.opacity-70
                                i.fas.fa-clock.mr-1
                                = new Date(c.createdAt).toLocaleDateString('vi-VN', { year: 'numeric', month: 'long', day: 'numeric' })
                        .flex.items-center.gap-1
                          - for (let i = 1; i <= 3; i++)
                            if c.rating >= i
                              i.fas.fa-star.text-warning.text-xl
                            else
                              i.far.fa-star.text-base-300.text-xl
                      p.text-base.leading-relaxed= c.content
            else
              .alert.alert-info
                i.fas.fa-info-circle
                span Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!

        // Comment Form
        if currentUser
          .card.bg-base-100.shadow-xl
            .card-body
              h3.card-title.text-2xl.mb-4
                i.fas.fa-edit.mr-2
                | #{myComment ? 'C·∫≠p Nh·∫≠t ƒê√°nh Gi√° C·ªßa B·∫°n' : 'Vi·∫øt ƒê√°nh Gi√°'}
              form#commentForm(method='post', action='/perfumes/' + perfume._id + '/comments')
                .form-control
                  label.label
                    span.label-text.text-lg.font-semibold
                      i.fas.fa-star.mr-2.text-warning
                      | ƒê√°nh gi√° c·ªßa b·∫°n
                  .flex.items-center.gap-3
                    input#rating1.hidden(type='radio', name='rating', value='1', checked=(myComment && myComment.rating === 1), required)
                    label.cursor-pointer.transition-transform(for='rating1', class='hover:scale-110')
                      i.fas.fa-star.text-5xl.star-input(data-value='1')
                    
                    input#rating2.hidden(type='radio', name='rating', value='2', checked=(myComment && myComment.rating === 2))
                    label.cursor-pointer.transition-transform(for='rating2', class='hover:scale-110')
                      i.fas.fa-star.text-5xl.star-input(data-value='2')
                    
                    input#rating3.hidden(type='radio', name='rating', value='3', checked=(myComment && myComment.rating === 3 || !myComment))
                    label.cursor-pointer.transition-transform(for='rating3', class='hover:scale-110')
                      i.fas.fa-star.text-5xl.star-input(data-value='3')
                    
                    span#ratingText.ml-4.text-xl.font-bold.text-primary
                
                .form-control.mt-6
                  label.label
                    span.label-text.text-lg.font-semibold
                      i.fas.fa-comment-dots.mr-2
                      | Nh·∫≠n x√©t c·ªßa b·∫°n
                  textarea.textarea.textarea-bordered.textarea-lg(name='content', rows='5', placeholder='Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m n√†y...', required)= myComment ? myComment.content : ''
                  label.label
                    span.label-text-alt.opacity-70 T·ªëi thi·ªÉu 10 k√Ω t·ª±
                
                .card-actions.justify-end.mt-6.gap-3
                  if myComment
                    button.btn.btn-error.btn-outline(type='button', onclick='confirmDelete()')
                      i.fas.fa-trash.mr-2
                      | X√≥a ƒë√°nh gi√°
                  button.btn.btn-primary.btn-lg(type='submit')
                    i.fas.fa-paper-plane.mr-2
                    | #{myComment ? 'C·∫≠p nh·∫≠t ƒë√°nh gi√°' : 'G·ª≠i ƒë√°nh gi√°'}
          
          if myComment
            form#deleteForm(method='post', action='/perfumes/' + perfume._id + '/comments/delete', style='display: none')
        else
          .card.bg-base-100.shadow-xl
            .card-body.text-center.py-12
              i.fas.fa-user-lock.text-6xl.text-base-300.mb-4
              h3.text-2xl.font-bold.mb-2 B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p
              p.text-lg.mb-6 Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ vi·∫øt ƒë√°nh gi√° v√† chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n
              .flex.gap-3.justify-center
                a.btn.btn-primary(href='/login')
                  i.fas.fa-sign-in-alt.mr-2
                  | ƒêƒÉng nh·∫≠p
                a.btn.btn-outline(href='/register')
                  i.fas.fa-user-plus.mr-2
                  | ƒêƒÉng k√Ω

      script.
        // Rating system - Simple and effective
        (function() {
          const stars = document.querySelectorAll('.star-input');
          const ratingText = document.getElementById('ratingText');
          const ratingLabels = {
            '1': 'üòû Kh√¥ng h√†i l√≤ng',
            '2': 'üòê B√¨nh th∆∞·ªùng', 
            '3': 'üòä R·∫•t h√†i l√≤ng'
          };
          
          function updateStarColors(rating) {
            stars.forEach(function(star) {
              const value = parseInt(star.getAttribute('data-value'));
              if (value <= rating) {
                star.classList.remove('text-base-300');
                star.classList.add('text-warning');
              } else {
                star.classList.remove('text-warning');
                star.classList.add('text-base-300');
              }
            });
            if (ratingText) {
              ratingText.textContent = ratingLabels[rating] || '';
            }
          }
          
          // Initialize on page load
          const checkedInput = document.querySelector('input[name="rating"]:checked');
          if (checkedInput) {
            updateStarColors(parseInt(checkedInput.value));
          } else {
            // Default to 3 stars
            updateStarColors(3);
          }
          
          // Click handler for each star
          stars.forEach(function(star) {
            star.addEventListener('click', function() {
              const value = this.getAttribute('data-value');
              document.getElementById('rating' + value).checked = true;
              updateStarColors(parseInt(value));
            });
            
            // Hover effect
            star.addEventListener('mouseenter', function() {
              const value = parseInt(this.getAttribute('data-value'));
              updateStarColors(value);
            });
          });
          
          // Reset on mouse leave form
          const form = document.getElementById('commentForm');
          if (form) {
            form.addEventListener('mouseleave', function() {
              const checkedInput = document.querySelector('input[name="rating"]:checked');
              if (checkedInput) {
                updateStarColors(parseInt(checkedInput.value));
              }
            });
          }
        })();
        
        function confirmDelete() {
          if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë√°nh gi√° c·ªßa m√¨nh?')) {
            document.getElementById('deleteForm').submit();
          }
        }
  else
    .container.mx-auto.px-4.py-20.text-center
      .alert.alert-error.max-w-md.mx-auto
        i.fas.fa-exclamation-circle.text-2xl
        div
          h3.font-bold Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m
          .text-sm S·∫£n ph·∫©m n√†y kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a
      a.btn.btn-primary.mt-6(href='/')
        i.fas.fa-home.mr-2
        | V·ªÅ trang ch·ªß
